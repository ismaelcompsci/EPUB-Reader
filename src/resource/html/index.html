<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EPUB.js</title>
    <script src="qrc:///reader/js/epub.min.js"></script>
    <script src="qrc:///reader/js/jszip.min.js"></script>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>

    <style type="text/css">
      .epub-container .epub-view > iframe {
        background: white;
        box-shadow: 0 0 4px #ccc;
        /*margin: 10px;
          padding: 20px;*/
      }

      #viewer {
        position: absolute;
        width: 100vw;
        height: 100vh;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }
    </style>
  </head>
  <body>
    <script src="qrc:///reader/js/epub.min.js"></script>
    <script src="qrc:///reader/js/jszip.min.js"></script>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>

    <div id="viewer"></div>
    <script>
      // LEARN MORE JS
      // epubcfi(/6/30!/4/2/18/1:1039) -> location  in book

      // CHANGE POS IN BOOK
      // rendition.on("relocated", function (location) {   -> location of book
      // console.log(location);

      // THEMES
      // rendition.themes.register("dark", "themes.css");
      // rendition.themes.register("light", "themes.css");
      // rendition.themes.register("tan", "themes.css");
      // rendition.themes.select("tan");
      // FONT SIZE
      // rendition.themes.fontSize("140%");

      // GLOBAL VARIABLE
      globalThis.book = null;
      globalThis.rendition = null;
      globalThis.backend = null;

      window.addEventListener("load", function () {
        new QWebChannel(qt.webChannelTransport, function (channel) {
          backend = channel.objects.backend;

          // Value from python backend
          backend.getFile(function (path) {
            // shoud do everything else invlolving the book after load book is done
            loadBook(path);

            // sets book theme and adds eventlistener
            backend.themeChanged.connect(setBookTheme);
          });
        });
      });

      // Load the opf or book
      const loadBook = (bookPath) => {
        book = ePub(bookPath);

        rendition = book.renderTo("viewer", {
          width: window.width,
          height: "100%",
        });

        // RESIZE BREAKS KEYLISTENER SO WE REINSTALL IT
        rendition.on("resized", (w, h) => {
          // document.removeEventListener("keyup", keyListener, false);

          // rendition.on("keyup", keyListener);
          // document.addEventListener("keyup", keyListener, false);
          console.log(w, h);
        });

        // position changed
        rendition.on("relocated", (location) => {
          // console.log(location.start.cfi);
        });

        book.ready
          .then(() => {
            rendition.display();
            // add themes
            rendition.themes.register("dark", "./themes.css");
            rendition.themes.register("light", "./themes.css");
            rendition.themes.register("tan", "./themes.css");
            rendition.ready = true;

            rendition.on("keyup", keyListener);
            document.addEventListener("keyup", keyListener, false);

            // setBookTheme(backend.getTheme);
          })
          .then(() => {});

        // var displayed = rendition.display();

        // rendition.on("keyup", keyListener);
        // document.addEventListener("keyup", keyListener, false);

        rendition.themes.default({
          h2: {
            "font-size": "32px",
          },
          p: {
            margin: "10px",
          },
        });

        // GET MAINWINDOW THEME
        backend.getTheme(function (theme) {
          rendition.themes.select(theme);
        });
        rendition.themes.select();
        rendition.themes.fontSize("110%");
      };

      // SET BOOK THEME light, dark, tan
      const setBookTheme = (theme) => {
        rendition.themes.select(theme.toLowerCase());
        // refresh();
      };

      const refresh = () => {
        // rendition.flow("scrolled");
        rendition.start();
      };

      const setFontSize = (size) => {
        rendition.themes.fontSize(size);
      };

      // THIS BREAKS WHEN WINDOW IS RESIZED
      // TRY TO USE QWEBCHANNEL TO CHANGE CHAPTER INSTEAD?
      var keyListener = function (e) {
        if (e.keyCode === 39) {
          nextPage();
        }

        if (e.keyCode === 37) {
          prevPage();
        }
      };

      function prevPage() {
        if (rendition) {
          rendition.prev();
        }
      }

      function nextPage() {
        if (rendition) {
          rendition.next();
        }
      }
      const debounce = (f, wait, immediate) => {
        let timeout;
        return (...args) => {
          const later = () => {
            timeout = null;
            if (!immediate) f(...args);
          };
          const callNow = immediate && !timeout;
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
          if (callNow) f(...args);
        };
      };
    </script>
  </body>
</html>
